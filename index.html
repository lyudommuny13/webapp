<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Messenger Font */
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap');

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* Hide Scrollbar but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Messenger Animations */
        .slide-enter-active,
        .slide-leave-active {
            transition: all 0.3s ease;
        }

        .slide-enter-from {
            transform: translateX(100%);
            opacity: 0;
        }

        .slide-leave-to {
            transform: translateX(-20%);
            opacity: 0;
        }

        /* Messenger specific colors */
        .bg-messenger {
            background-color: #0084ff;
        }

        .text-messenger {
            color: #0084ff;
        }

        .bg-messenger-gray {
            background-color: #f0f2f5;
        }

        /* Input placeholder color */
        ::placeholder {
            color: #65676b;
            opacity: 1;
        }
    </style>
</head>

<body class="bg-white h-[100dvh] w-full overflow-hidden">

    <div id="app" class="h-full w-full">
        <router-view v-slot="{ Component }">
            <transition name="slide" mode="out-in">
                <component :is="Component" />
            </transition>
        </router-view>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onUnmounted, nextTick, computed } = Vue;
        const { createRouter, createWebHashHistory, useRouter } = VueRouter;

        // ============================================================
        // ⚠️ PASTE YOUR GOOGLE SCRIPT URL HERE ⚠️
        // ============================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzLufiGq2VVCuZNyJe4UEHYrIW6pfgjnY8M6C9a1OvkyyNwOdbFkHTeynoTuomzSGZp/exec';

        // ==========================================
        // API SERVICE
        // ==========================================
        const api = {
            async post(data) {
                try {
                    const res = await axios.post(API_URL, JSON.stringify(data), {
                        headers: { 'Content-Type': 'text/plain' }
                    });
                    return res.data;
                } catch (e) {
                    console.error(e);
                    return { success: false, message: "Connection Error" };
                }
            }
        };

        // ==========================================
        // LOGIN SCREEN (Meta Style)
        // ==========================================
        const AuthView = {
            template: `
            <div class="h-full flex flex-col items-center justify-center px-6 bg-white sm:bg-gray-100">
                <div class="w-full max-w-[400px] sm:bg-white sm:p-8 sm:rounded-xl sm:shadow-lg">
                    <div class="flex flex-col items-center mb-10">
                        <div class="w-20 h-20 rounded-full bg-messenger flex items-center justify-center shadow-sm mb-4">
                            <svg class="w-12 h-12 text-white" viewBox="0 0 28 28" fill="currentColor"><path d="M14 2.042c6.76 0 12 4.952 12 11.64S20.76 25.322 14 25.322a13.091 13.091 0 0 1-3.474-.461.956 .956 0 0 0-.641.047L7.5 25.959a.961.961 0 0 1-1.348-.849l-.065-2.134a.957.957 0 0 0-.322-.684A11.389 11.389 0 0 1 2 13.682C2 6.994 7.24 2.042 14 2.042ZM6.794 17.086a.57.57 0 0 0 .827.758l3.786-2.874a.722.722 0 0 1 .868 0l2.8 2.1a1.8 1.8 0 0 0 2.6-.481l3.525-5.592a.57.57 0 0 0-.827-.758l-3.786 2.874a.722.722 0 0 1-.868 0l-2.8-2.1a1.8 1.8 0 0 0-2.6.481Z"/></svg>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900">Messenger</h1>
                    </div>

                    <form @submit.prevent="submit" class="space-y-4 w-full">
                        <div v-if="!isLogin">
                            <input v-model="form.name" type="text" class="w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:border-messenger focus:ring-1 focus:ring-messenger outline-none transition text-[15px]" placeholder="Full Name" required>
                        </div>
                        <div>
                            <input v-model="form.username" type="text" class="w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:border-messenger focus:ring-1 focus:ring-messenger outline-none transition text-[15px]" placeholder="Username" required>
                        </div>
                        <div>
                            <input v-model="form.password" type="password" class="w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:border-messenger focus:ring-1 focus:ring-messenger outline-none transition text-[15px]" placeholder="Password" required>
                        </div>

                        <div v-if="error" class="text-red-500 text-sm text-center">{{ error }}</div>

                        <button :disabled="loading" class="w-full py-3 bg-messenger text-white font-semibold rounded-xl text-[17px] transition hover:bg-blue-600 disabled:opacity-50">
                            {{ loading ? 'Logging in...' : (isLogin ? 'Log In' : 'Create Account') }}
                        </button>
                    </form>

                    <div class="mt-8 text-center">
                        <button @click="toggle" class="text-sm font-medium text-gray-900 hover:underline">
                            {{ isLogin ? "Create New Account" : "Back to Login" }}
                        </button>
                    </div>
                </div>
                
                <div class="fixed bottom-6 text-center">
                    <span class="text-xs text-gray-400 font-semibold tracking-wider">FROM META</span>
                </div>
            </div>
            `,
            setup() {
                const router = useRouter();
                const isLogin = ref(true);
                const loading = ref(false);
                const error = ref('');
                const form = reactive({ name: '', username: '', password: '' });

                const toggle = () => { isLogin.value = !isLogin.value; error.value = ''; };

                const submit = async () => {
                    loading.value = true; error.value = '';
                    const payload = { action: isLogin.value ? 'login' : 'register', ...form };
                    const res = await api.post(payload);

                    if (res.success) {
                        localStorage.setItem('token', res.token);
                        localStorage.setItem('user', JSON.stringify(res.user));
                        router.push('/chat');
                    } else {
                        error.value = res.message || 'Login failed';
                    }
                    loading.value = false;
                };
                return { isLogin, loading, error, form, toggle, submit };
            }
        };

        // ==========================================
        // CHAT SCREEN (Messenger Clone)
        // ==========================================
        const ChatView = {
            template: `
            <div class="flex flex-col h-full w-full max-w-[700px] mx-auto bg-white relative sm:border-x sm:border-gray-200 shadow-xl">
                
                <div class="h-16 px-4 flex items-center justify-between shadow-sm z-20 bg-white/95 backdrop-blur sticky top-0">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                             <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold text-lg overflow-hidden">
                                <img src="https://ui-avatars.com/api/?name=Group+Chat&background=random" alt="Group" />
                             </div>
                             <div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full"></div>
                        </div>
                        <div class="flex flex-col">
                            <span class="font-bold text-[17px] text-gray-900 leading-tight">Team Chat</span>
                            <span class="text-[12px] text-gray-500">Active now</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-6 text-messenger">
                        <svg class="w-6 h-6 cursor-pointer" fill="currentColor" viewBox="0 0 24 24"><path d="M18.5 2h-13A3.5 3.5 0 0 0 2 5.5v13A3.5 3.5 0 0 0 5.5 22h13a3.5 3.5 0 0 0 3.5-3.5v-13A3.5 3.5 0 0 0 18.5 2zm-4.5 15h-4v-4h4v4zm2.72-5.12-1.39 1.39a.98.98 0 0 1-.71.3H8.88a1 1 0 0 1-.71-.29l-1.39-1.4a2.96 2.96 0 0 1 0-4.18l1.4-1.39a1 1 0 0 1 1.41 0l1.39 1.39a1 1 0 0 1 0 1.41l-.77.78a.98.98 0 0 0 0 1.39l2.24 2.24a.98.98 0 0 0 1.39 0l.78-.77a1 1 0 0 1 1.41 0z"/></svg>
                        <svg class="w-7 h-7 cursor-pointer" fill="currentColor" viewBox="0 0 24 24"><path d="M18 10.48V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4.48l4 3.98v-11l-4 3.98z"/></svg>
                        <button @click="logout" class="w-6 h-6 text-gray-400 hover:text-red-500">
                            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </div>

                <div id="chatBox" class="flex-1 overflow-y-auto p-4 bg-white space-y-1">
                    <div v-if="loading && messages.length === 0" class="flex justify-center py-10">
                        <svg class="animate-spin h-8 w-8 text-messenger" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </div>

                    <div class="h-4"></div>

                    <div v-for="(msg, index) in messages" :key="msg.id || index" class="flex w-full mb-1" :class="isMe(msg) ? 'justify-end' : 'justify-start'">
                        
                        <div v-if="!isMe(msg)" class="w-7 h-7 mr-2 self-end mb-1">
                             <img :src="'https://ui-avatars.com/api/?name=' + msg.sender + '&background=random&size=32'" class="rounded-full w-full h-full">
                        </div>

                        <div class="max-w-[70%] break-words px-3.5 py-2 text-[15px] leading-snug"
                             :class="isMe(msg) 
                                ? 'bg-messenger text-white rounded-[18px] rounded-br-md' 
                                : 'bg-messenger-gray text-black rounded-[18px] rounded-bl-md'">
                            {{ msg.content }}
                        </div>
                    </div>
                </div>

                <div class="p-2 bg-white flex items-center gap-2 border-t border-gray-100">
                    <div class="flex items-center gap-3 text-messenger px-1">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                        <svg class="w-6 h-6 hidden sm:block" fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </div>

                    <div class="flex-1 bg-messenger-gray rounded-full px-4 py-2 flex items-center">
                        <input 
                            v-model="text" 
                            @keyup.enter="send"
                            type="text" 
                            placeholder="Aa" 
                            class="bg-transparent border-none focus:ring-0 outline-none w-full text-[15px] text-gray-900"
                        >
                        <svg class="w-6 h-6 text-gray-400 cursor-pointer" fill="currentColor" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                    </div>

                    <button @click="send" class="p-2 text-messenger hover:bg-gray-100 rounded-full transition">
                        <svg v-if="text.trim()" class="w-5 h-5 rotate-45 -ml-1 mt-1" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        <svg v-else class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/></svg>
                    </button>
                </div>
            </div>
            `,
            setup() {
                const router = useRouter();
                const user = ref(JSON.parse(localStorage.getItem('user') || '{}'));
                const messages = ref([]);
                const text = ref('');
                const loading = ref(true);
                let interval = null;

                const isMe = (msg) => msg.sender === user.value.username;

                const scroll = () => {
                    nextTick(() => {
                        const box = document.getElementById('chatBox');
                        if (box) box.scrollTop = box.scrollHeight;
                    });
                };

                const loadMessages = async () => {
                    const res = await api.post({ action: 'getMessages' });
                    if (res.success) {
                        const prevLen = messages.value.length;
                        if (res.messages.length !== prevLen) {
                            messages.value = res.messages;
                            scroll();
                        }
                    }
                    loading.value = false;
                };

                const send = async () => {
                    if (!text.value.trim()) return; // Can add "Like" logic here later

                    const content = text.value;
                    text.value = '';

                    // Optimistic UI
                    messages.value.push({
                        id: Date.now(),
                        sender: user.value.username,
                        content: content
                    });
                    scroll();

                    await api.post({
                        action: 'sendMessage',
                        username: user.value.username,
                        message: content
                    });
                    loadMessages();
                };

                const logout = () => {
                    localStorage.clear();
                    router.push('/');
                };

                onMounted(() => {
                    loadMessages();
                    interval = setInterval(loadMessages, 2500); // Fast poll
                });

                onUnmounted(() => clearInterval(interval));

                return { user, messages, text, loading, isMe, send, logout };
            }
        };

        // ==========================================
        // APP INIT
        // ==========================================
        const routes = [
            { path: '/', component: AuthView },
            { path: '/chat', component: ChatView, meta: { requiresAuth: true } }
        ];

        const router = createRouter({ history: createWebHashHistory(), routes });

        router.beforeEach((to, from, next) => {
            const auth = localStorage.getItem('token');
            if (to.meta.requiresAuth && !auth) next('/');
            else if (to.path === '/' && auth) next('/chat');
            else next();
        });

        createApp({}).use(router).mount('#app');
    </script>
</body>

</html>